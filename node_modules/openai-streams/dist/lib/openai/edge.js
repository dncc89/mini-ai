import{streamArray as c}from"yield-stream";import{OpenAIAPIEndpoints as b}from"../types.js";import{ENCODER as m}from"../../globs/shared.js";import{OpenAIError as e}from"../errors.js";import{fetchWithBackoff as u}from"../backoff.js";import{ChatStream as R,EventStream as g,getTokensFromResponse as y,TokenStream as S}from"../streaming/index.js";const $=async(n,h,{mode:r="tokens",apiBase:f="https://api.openai.com/v1",apiKey:i=process.env.OPENAI_API_KEY,apiHeaders:d={},controller:l,onDone:A,onParse:E}={})=>{if(!i)throw new e("NO_API_KEY");const p=n==="completions"||n==="chat",I=b[n],t=await u(`${f}/${I}`,{method:"POST",body:JSON.stringify({...h,stream:p?!0:void 0}),headers:{Authorization:`Bearer ${i}`,"Content-Type":"application/json",Accept:"application/json",...d},signal:l?.signal});switch(t.status){case 401:throw new e("INVALID_API_KEY");case 404:throw new e("INVALID_MODEL");case 429:throw new e("RATE_LIMIT_REACHED");case 500:throw new e("SERVER_ERROR");default:if(!t.body)throw new e("UNKNOWN")}let o;const s={mode:r,onDone:A,onParse:E};if(p)switch(r){case"raw":o=g(t.body,s);break;case"tokens":switch(n){case"chat":o=R(t.body,s);break;default:o=S(t.body,s);break}break;default:throw console.error(`Unknown mode: ${r} for streaming response.`),new e("UNKNOWN")}else{const a=await t.text();switch(r){case"tokens":const N=JSON.parse(a),w=y(N);if(typeof w!="string"){console.error("No text choices received from OpenAI: "+a),o=c([]);break}const O=m.encode(w);o=c([O]);break;case"raw":const k=m.encode(a);o=c([k]);break;default:throw console.error(`Unknown mode: ${r} for non-streaming response.`),new e("UNKNOWN")}}return o};export{$ as OpenAI};
